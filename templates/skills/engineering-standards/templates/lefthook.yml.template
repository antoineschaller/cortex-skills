# Lefthook Git Hooks Configuration
# Template for {{project_name}}
# Generated by engineering-standards skill

# Pre-commit hooks (target: <2s for fast feedback)
pre-commit:
  parallel: true
  commands:
    # Auto-format staged files
    format:
      glob: '*.{js,jsx,ts,tsx,json,md,yaml,yml}'
      run: {{package_manager}} prettier --write {staged_files}
      stage_fixed: true

    # Validate WIP file structure
    wip-validation:
      glob: '{{wip_directory}}/*.md'
      run: |
        for file in {staged_files}; do
          # Check naming convention (WIP_* or BUG_INVESTIGATION_*)
          if [[ ! $(basename "$file") =~ ^(WIP_|BUG_INVESTIGATION_) ]]; then
            echo "❌ WIP file must start with WIP_ or BUG_INVESTIGATION_: $file"
            exit 1
          fi

          # Check file age (max 7 days)
          if [ $(find "$file" -mtime +7 | wc -l) -gt 0 ]; then
            echo "⚠️  WIP file is stale (>7 days): $file"
            echo "   Update or archive it to docs/wip/completed/"
            exit 1
          fi

          # Check required sections
          if ! grep -q "## Last Updated" "$file"; then
            echo "❌ WIP file missing '## Last Updated' section: $file"
            exit 1
          fi
          if ! grep -q "## Objective" "$file"; then
            echo "❌ WIP file missing '## Objective' section: $file"
            exit 1
          fi
        done
      fail_text: 'WIP validation failed'

    # Validate migration idempotency (Supabase projects only)
    migration-idempotency:
      glob: '{{migrations_directory}}/*.sql'
      run: |
        for file in {staged_files}; do
          content=$(cat "$file")

          # Check CREATE POLICY without DO $$ block
          if echo "$content" | grep -qE 'CREATE POLICY.*ON' && ! echo "$content" | grep -qE 'DO \$\$'; then
            echo "❌ Non-idempotent CREATE POLICY in $file"
            echo "   Wrap in DO \$\$ block with IF NOT EXISTS check"
            exit 1
          fi

          # Check CREATE TRIGGER without DROP IF EXISTS
          if echo "$content" | grep -qE 'CREATE TRIGGER' && ! echo "$content" | grep -qE 'DROP TRIGGER IF EXISTS'; then
            echo "❌ Non-idempotent CREATE TRIGGER in $file"
            echo "   Add 'DROP TRIGGER IF EXISTS trigger_name ON table_name;' before CREATE"
            exit 1
          fi

          # Check ADD CONSTRAINT without DO $$ block
          if echo "$content" | grep -qE 'ADD CONSTRAINT' && ! echo "$content" | grep -qE 'DO \$\$'; then
            echo "❌ Non-idempotent ADD CONSTRAINT in $file"
            echo "   Wrap in DO \$\$ block with constraint existence check"
            exit 1
          fi

          # Check CREATE INDEX without IF NOT EXISTS
          if echo "$content" | grep -qE 'CREATE INDEX' && ! echo "$content" | grep -qE 'IF NOT EXISTS'; then
            echo "⚠️  Warning: CREATE INDEX without IF NOT EXISTS in $file"
          fi

          # Check ADD COLUMN without IF NOT EXISTS
          if echo "$content" | grep -qE 'ADD COLUMN' && ! echo "$content" | grep -qE 'IF NOT EXISTS'; then
            echo "⚠️  Warning: ADD COLUMN without IF NOT EXISTS in $file"
          fi
        done
      fail_text: 'Migration idempotency validation failed'
      skip:
        - merge
        - rebase

    # Block root .md files (except allowed)
    block-root-md:
      glob: '*.md'
      run: |
        for file in {staged_files}; do
          basename=$(basename "$file")
          if [[ "$basename" != "CLAUDE.md" && "$basename" != "README.md" && "$basename" != "CHANGELOG.md" && "$basename" != "CONTRIBUTING.md" && "$basename" != "LICENSE.md" ]]; then
            echo "❌ BLOCKED: Root .md file not allowed: $file"
            echo "   Move to docs/wip/active/ (temporary) or docs/guides/ (permanent)"
            exit 1
          fi
        done
      fail_text: 'Root MD file blocked'

    # Validate RLS policies (Supabase projects only)
    rls-validation:
      glob: '{{migrations_directory}}/*_rls_*.sql'
      run: |
        for file in {staged_files}; do
          content=$(cat "$file")

          # Check for super admin bypass
          if echo "$content" | grep -qE 'CREATE POLICY.*ON' && ! echo "$content" | grep -qE 'is_super_admin\(\)'; then
            echo "⚠️  Warning: RLS policy without super admin bypass in $file"
            echo "   Consider adding 'OR is_super_admin()' to USING clause"
          fi
        done
      skip:
        - merge
        - rebase

# Pre-push hooks (target: 30-60s for thorough checks)
pre-push:
  parallel: true
  commands:
    # Fast lint with oxlint (critical rules only)
    oxlint:
      run: |
        if command -v oxlint &> /dev/null; then
          pnpm oxlint \
            --deny=no-debugger \
            --deny=no-const-assign \
            --deny=no-dupe-keys \
            --deny=no-self-assign \
            --ignore-path=.gitignore \
            {{source_directories}}
        else
          echo "⚠️  oxlint not installed, skipping fast lint"
        fi

    # Full typecheck (conditional on THOROUGH env var)
    typecheck:
      run: |
        if [ "${THOROUGH:-0}" = "1" ]; then
          echo "Running full typecheck (THOROUGH=1)..."
          {{package_manager}} turbo typecheck --affected
        else
          echo "Skipping typecheck (set THOROUGH=1 to enable)"
        fi

    # Validate lockfile is in sync
    lockfile-sync:
      run: |
        {{package_manager}} install --frozen-lockfile
      fail_text: 'pnpm-lock.yaml is out of sync. Run {{package_manager}} install and commit.'

    # Validate database types match schema (Supabase projects only)
    db-type-validation:
      run: |
        if [ -f "{{migrations_directory}}" ]; then
          echo "Checking database types are up to date..."
          # Run type generation in check mode
          CURRENT_TYPES=$(cat {{database_types_file}})
          {{typegen_command}} > /tmp/new-types.ts
          NEW_TYPES=$(cat /tmp/new-types.ts)

          if [ "$CURRENT_TYPES" != "$NEW_TYPES" ]; then
            echo "❌ Database types are out of sync"
            echo "   Run: {{typegen_command}}"
            exit 1
          fi
          rm /tmp/new-types.ts
        fi
      skip:
        - merge
        - rebase

# Post-checkout hook (warn if main directory not on default branch)
post-checkout:
  commands:
    check-branch:
      run: |
        REPO_ROOT=$(git rev-parse --show-toplevel)
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        DEFAULT_BRANCH="{{default_branch}}"

        # Only warn in main directory (not worktrees)
        if [[ "$REPO_ROOT" != *"-worktrees"* && "$CURRENT_BRANCH" != "$DEFAULT_BRANCH" ]]; then
          echo "⚠️  WARNING: Main directory is on branch '$CURRENT_BRANCH'"
          echo "   Expected: '$DEFAULT_BRANCH'"
          echo "   Use worktrees for feature branches: ./scripts/git-worktree.sh $CURRENT_BRANCH"
        fi

# Skip patterns (apply to all hooks)
skip_output:
  - meta
  - summary

# Environment variables
# Set LEFTHOOK=0 to skip all hooks: LEFTHOOK=0 git commit
# Set THOROUGH=1 for comprehensive pre-push checks: THOROUGH=1 git push
